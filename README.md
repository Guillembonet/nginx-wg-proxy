This code has been almost fully generated by Chat GPT.